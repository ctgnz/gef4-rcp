/*******************************************************************************
 * Copyright (c) 2014, 2015 itemis AG and others.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *     Alexander Ny√üen (itemis AG) - initial API and implementation
 *
 *******************************************************************************/
package org.eclipse.gef4.mvc.examples.logo.rcp;

import org.eclipse.gef4.common.adapt.AdapterKey;
import org.eclipse.gef4.common.adapt.inject.AdaptableScopes;
import org.eclipse.gef4.common.adapt.inject.AdapterMap;
import org.eclipse.gef4.common.adapt.inject.AdapterMaps;
import org.eclipse.gef4.mvc.behaviors.HoverBehavior;
import org.eclipse.gef4.mvc.behaviors.SelectionBehavior;
import org.eclipse.gef4.mvc.examples.logo.rcp.parts.FXCreateCurveHoverHandlePart;
import org.eclipse.gef4.mvc.examples.logo.rcp.parts.FXDeleteHoverHandlePart;
import org.eclipse.gef4.mvc.examples.logo.rcp.parts.FXGeometricCurvePart;
import org.eclipse.gef4.mvc.examples.logo.rcp.parts.FXGeometricModelPart;
import org.eclipse.gef4.mvc.examples.logo.rcp.parts.FXGeometricShapePart;
import org.eclipse.gef4.mvc.examples.logo.rcp.parts.FXLogoContentPartFactory;
import org.eclipse.gef4.mvc.examples.logo.rcp.parts.FXLogoHoverHandlePartFactory;
import org.eclipse.gef4.mvc.examples.logo.rcp.parts.FXLogoSelectionHandlePartFactory;
import org.eclipse.gef4.mvc.examples.logo.rcp.policies.CloneCurvePolicy;
import org.eclipse.gef4.mvc.examples.logo.rcp.policies.CloneShapePolicy;
import org.eclipse.gef4.mvc.examples.logo.rcp.policies.FXCloneOnClickPolicy;
import org.eclipse.gef4.mvc.examples.logo.rcp.policies.FXCreateCurveOnDragPolicy;
import org.eclipse.gef4.mvc.examples.logo.rcp.policies.FXCreationMenuItemProvider;
import org.eclipse.gef4.mvc.examples.logo.rcp.policies.FXCreationMenuOnClickPolicy;
import org.eclipse.gef4.mvc.examples.logo.rcp.policies.FXDeleteFirstAnchorageOnClickPolicy;
import org.eclipse.gef4.mvc.examples.logo.rcp.policies.FXRelocateLinkedOnDragPolicy;
import org.eclipse.gef4.mvc.fx.MvcFxModule;
import org.eclipse.gef4.mvc.fx.behaviors.FXConnectionClickableAreaBehavior;
import org.eclipse.gef4.mvc.fx.domain.FXDomain;
import org.eclipse.gef4.mvc.fx.parts.FXCircleSegmentHandlePart;
import org.eclipse.gef4.mvc.fx.parts.FXDefaultFocusFeedbackPartFactory;
import org.eclipse.gef4.mvc.fx.parts.FXDefaultHoverFeedbackPartFactory;
import org.eclipse.gef4.mvc.fx.parts.FXDefaultHoverHandlePartFactory;
import org.eclipse.gef4.mvc.fx.parts.FXDefaultSelectionFeedbackPartFactory;
import org.eclipse.gef4.mvc.fx.parts.FXDefaultSelectionHandlePartFactory;
import org.eclipse.gef4.mvc.fx.parts.FXRectangleSegmentHandlePart;
import org.eclipse.gef4.mvc.fx.parts.FXSquareSegmentHandlePart;
import org.eclipse.gef4.mvc.fx.policies.FXBendConnectionPolicy;
import org.eclipse.gef4.mvc.fx.policies.FXBendFirstAnchorageOnSegmentHandleDragPolicy;
import org.eclipse.gef4.mvc.fx.policies.FXBendOnSegmentDragPolicy;
import org.eclipse.gef4.mvc.fx.policies.FXDeleteSelectedOnTypePolicy;
import org.eclipse.gef4.mvc.fx.policies.FXFocusAndSelectOnClickPolicy;
import org.eclipse.gef4.mvc.fx.policies.FXHoverOnHoverPolicy;
import org.eclipse.gef4.mvc.fx.policies.FXNormalizeConnectedOnDragPolicy;
import org.eclipse.gef4.mvc.fx.policies.FXResizeConnectionPolicy;
import org.eclipse.gef4.mvc.fx.policies.FXResizePolicy;
import org.eclipse.gef4.mvc.fx.policies.FXResizeTransformSelectedOnHandleDragPolicy;
import org.eclipse.gef4.mvc.fx.policies.FXResizeTranslateFirstAnchorageOnHandleDragPolicy;
import org.eclipse.gef4.mvc.fx.policies.FXRotateSelectedOnHandleDragPolicy;
import org.eclipse.gef4.mvc.fx.policies.FXRotateSelectedOnRotatePolicy;
import org.eclipse.gef4.mvc.fx.policies.FXSelectFocusedOnTypePolicy;
import org.eclipse.gef4.mvc.fx.policies.FXTransformConnectionPolicy;
import org.eclipse.gef4.mvc.fx.policies.FXTransformPolicy;
import org.eclipse.gef4.mvc.fx.policies.FXTranslateSelectedOnDragPolicy;
import org.eclipse.gef4.mvc.fx.policies.FXTraverseFocusOnTypePolicy;
import org.eclipse.gef4.mvc.fx.providers.DynamicAnchorProvider;
import org.eclipse.gef4.mvc.fx.providers.GeometricOutlineProvider;
import org.eclipse.gef4.mvc.fx.providers.ShapeBoundsProvider;
import org.eclipse.gef4.mvc.fx.viewer.FXViewer;
import org.eclipse.gef4.mvc.parts.IContentPartFactory;
import org.eclipse.gef4.mvc.parts.IHandlePartFactory;

import com.google.inject.Binder;
import com.google.inject.Provider;
import com.google.inject.TypeLiteral;
import com.google.inject.multibindings.MapBinder;
import com.google.inject.name.Names;

import javafx.scene.Node;

public class MvcLogoExampleModule extends MvcFxModule {

  public static final String PALETTE_VIEWER_ROLE = "paletteViewer";

  @Override
  protected void bindAbstractContentPartAdapters(
    MapBinder<AdapterKey<?>, Object> adapterMapBinder) {
    super.bindAbstractContentPartAdapters(adapterMapBinder);
    // select on click
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXFocusAndSelectOnClickPolicy.class);
    // select on type
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXSelectFocusedOnTypePolicy.class);
  }

  @Override
  protected void bindAbstractRootPartAdapters(
    MapBinder<AdapterKey<?>, Object> adapterMapBinder) {
    super.bindAbstractRootPartAdapters(adapterMapBinder);
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXCreationMenuOnClickPolicy.class);
    adapterMapBinder
    .addBinding(AdapterKey
                .role(FXCreationMenuOnClickPolicy.MENU_ITEM_PROVIDER_ROLE))
    .to(FXCreationMenuItemProvider.class);
    // interaction policy to delete on key type
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXDeleteSelectedOnTypePolicy.class);
    // interaction policy to rotate selected through rotate gesture
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXRotateSelectedOnRotatePolicy.class);
    // keyboard focus traversal through key navigation
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXTraverseFocusOnTypePolicy.class);
    // select on type
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXSelectFocusedOnTypePolicy.class);
  }

  protected void bindFXCircleSegmentHandlePartAdapters(
    MapBinder<AdapterKey<?>, Object> adapterMapBinder) {
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXBendFirstAnchorageOnSegmentHandleDragPolicy.class);
  }

  protected void bindFXCreateCurveHandlePartAdapters(
    MapBinder<AdapterKey<?>, Object> adapterMapBinder) {
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXCreateCurveOnDragPolicy.class);
  }

  protected void bindFXDeleteHandlePartAdapters(
    MapBinder<AdapterKey<?>, Object> adapterMapBinder) {
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXDeleteFirstAnchorageOnClickPolicy.class);
  }

  @Override
  protected void bindFXDomainAdapters(
    MapBinder<AdapterKey<?>, Object> adapterMapBinder) {
    super.bindFXDomainAdapters(adapterMapBinder);
    // bindFXPaletteViewerAsFXDomainAdapter(adapterMapBinder);
  }

  protected void bindFXGeometricCurvePartAdapters(
    MapBinder<AdapterKey<?>, Object> adapterMapBinder) {
    // hover on hover
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXHoverOnHoverPolicy.class);

    // geometry provider for selection feedback
    adapterMapBinder
    .addBinding(AdapterKey
                .role(FXDefaultSelectionFeedbackPartFactory.SELECTION_FEEDBACK_GEOMETRY_PROVIDER))
    .to(GeometricOutlineProvider.class);
    // geometry provider for selection handles
    adapterMapBinder
    .addBinding(AdapterKey
                .role(FXDefaultSelectionHandlePartFactory.SELECTION_HANDLES_GEOMETRY_PROVIDER))
    .to(GeometricOutlineProvider.class);
    adapterMapBinder
    .addBinding(AdapterKey
                .role(FXDefaultSelectionFeedbackPartFactory.SELECTION_LINK_FEEDBACK_GEOMETRY_PROVIDER))
    .to(GeometricOutlineProvider.class);
    // geometry provider for hover feedback
    adapterMapBinder
    .addBinding(AdapterKey
                .role(FXDefaultHoverFeedbackPartFactory.HOVER_FEEDBACK_GEOMETRY_PROVIDER))
    .to(GeometricOutlineProvider.class);
    // geometry provider for focus feedback
    adapterMapBinder
    .addBinding(AdapterKey
                .role(FXDefaultFocusFeedbackPartFactory.FOCUS_FEEDBACK_GEOMETRY_PROVIDER))
    .to(GeometricOutlineProvider.class);

    // transaction policy for resize + transform
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXResizeConnectionPolicy.class);

    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXBendConnectionPolicy.class);

    // interaction policy to relocate on drag
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXTranslateSelectedOnDragPolicy.class);

    // drag individual segments
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXBendOnSegmentDragPolicy.class);

    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXTransformConnectionPolicy.class);

    // cloning
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(CloneCurvePolicy.class);

    // clickable area resizing
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXConnectionClickableAreaBehavior.class);

    // clone on shift+click
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXCloneOnClickPolicy.class);
  }

  /**
   * Binds adapters for {@link FXGeometricModelPart}.
   *
   * @param adapterMapBinder
   *            The adapter map binder to which the bindings are added.
   */
  protected void bindFXGeometricModelPartAdapters(
    MapBinder<AdapterKey<?>, Object> adapterMapBinder) {
    // geometry provider for focus feedback
    adapterMapBinder
    .addBinding(AdapterKey
                .role(FXDefaultFocusFeedbackPartFactory.FOCUS_FEEDBACK_GEOMETRY_PROVIDER))
    .to(ShapeBoundsProvider.class);
  }

  protected void bindFXGeometricShapePartAdapters(
    MapBinder<AdapterKey<?>, Object> adapterMapBinder) {
    // hover on hover
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXHoverOnHoverPolicy.class);

    // geometry provider for selection feedback
    adapterMapBinder
    .addBinding(AdapterKey
                .role(FXDefaultSelectionFeedbackPartFactory.SELECTION_FEEDBACK_GEOMETRY_PROVIDER))
    .toProvider(new Provider<ShapeBoundsProvider>() {
      @Override
      public ShapeBoundsProvider get() {
        return new ShapeBoundsProvider(0.5);
      }
    });
    // geometry provider for selection handles
    adapterMapBinder
    .addBinding(AdapterKey
                .role(FXDefaultSelectionHandlePartFactory.SELECTION_HANDLES_GEOMETRY_PROVIDER))
    .toProvider(new Provider<ShapeBoundsProvider>() {
      @Override
      public ShapeBoundsProvider get() {
        return new ShapeBoundsProvider(0.5);
      }
    });
    adapterMapBinder
    .addBinding(AdapterKey
                .role(FXDefaultSelectionFeedbackPartFactory.SELECTION_LINK_FEEDBACK_GEOMETRY_PROVIDER))
    .to(GeometricOutlineProvider.class);
    // geometry provider for hover feedback
    adapterMapBinder
    .addBinding(AdapterKey
                .role(FXDefaultHoverFeedbackPartFactory.HOVER_FEEDBACK_GEOMETRY_PROVIDER))
    .to(ShapeBoundsProvider.class);
    // geometry provider for hover handles
    adapterMapBinder
    .addBinding(AdapterKey
                .role(FXDefaultHoverHandlePartFactory.HOVER_HANDLES_GEOMETRY_PROVIDER))
    .to(ShapeBoundsProvider.class);
    // geometry provider for focus feedback
    adapterMapBinder
    .addBinding(AdapterKey
                .role(FXDefaultFocusFeedbackPartFactory.FOCUS_FEEDBACK_GEOMETRY_PROVIDER))
    .toProvider(new Provider<ShapeBoundsProvider>() {
      @Override
      public ShapeBoundsProvider get() {
        return new ShapeBoundsProvider(0.5);
      }
    });

    // register resize/transform policies (writing changes also to model)
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXTransformPolicy.class);
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXResizePolicy.class);

    // relocate on drag (including anchored elements, which are linked)
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXTranslateSelectedOnDragPolicy.class);
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXRelocateLinkedOnDragPolicy.class);

    // clone
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(CloneShapePolicy.class);

    // bind dynamic anchor provider
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(DynamicAnchorProvider.class);

    // clone on shift+click
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXCloneOnClickPolicy.class);

    // normalize connected on drag
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXNormalizeConnectedOnDragPolicy.class);
  }

  /**
   * Adds a binding for {@link FXPaletteViewer} to the {@link AdapterMap}
   * binder for {@link FXDomain}.
   *
   * @param adapterMapBinder
   *            The {@link MapBinder} to be used for the binding registration.
   *            In this case, will be obtained from
   *            {@link AdapterMaps#getAdapterMapBinder(Binder, Class)} using
   *            {@link FXDomain} as a key.
   *
   * @see AdapterMaps#getAdapterMapBinder(Binder, Class)
   */
  protected void bindFXPaletteViewerAsFXDomainAdapter(
    MapBinder<AdapterKey<?>, Object> adapterMapBinder) {
    adapterMapBinder.addBinding(AdapterKey.role(PALETTE_VIEWER_ROLE))
    .to(FXViewer.class);
  }

  protected void bindFXRectangleSegmentHandlePartAdapters(
    MapBinder<AdapterKey<?>, Object> adapterMapBinder) {
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXBendFirstAnchorageOnSegmentHandleDragPolicy.class);
  }

  protected void bindFXSquareSegmentHandlePartAdapters(
    MapBinder<AdapterKey<?>, Object> adapterMapBinder) {
    // single selection: resize relocate on handle drag without modifier
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXResizeTranslateFirstAnchorageOnHandleDragPolicy.class);
    // rotate on drag + control
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXRotateSelectedOnHandleDragPolicy.class);

    // multi selection: scale relocate on handle drag without modifier
    adapterMapBinder.addBinding(AdapterKey.defaultRole())
    .to(FXResizeTransformSelectedOnHandleDragPolicy.class);
  }

  protected void bindIContentPartFactory() {
    binder().bind(new TypeLiteral<IContentPartFactory<Node>>() {
    }).toInstance(new FXLogoContentPartFactory());
  }

  @Override
  protected void bindIHandlePartFactories() {
    binder().bind(new TypeLiteral<IHandlePartFactory<Node>>() {
    }).annotatedWith(
                     Names.named(SelectionBehavior.PART_FACTORIES_BINDING_NAME))
    .to(FXLogoSelectionHandlePartFactory.class)
    .in(AdaptableScopes.typed(FXViewer.class));
    binder().bind(new TypeLiteral<IHandlePartFactory<Node>>() {
    }).annotatedWith(Names.named(HoverBehavior.PART_FACTORIES_BINDING_NAME))
    .to(FXLogoHoverHandlePartFactory.class)
    .in(AdaptableScopes.typed(FXViewer.class));
  }

  @Override
  protected void configure() {
    super.configure();

    bindIContentPartFactory();

    // contents
    bindFXGeometricModelPartAdapters(AdapterMaps
                                     .getAdapterMapBinder(binder(), FXGeometricModelPart.class));
    bindFXGeometricShapePartAdapters(AdapterMaps
                                     .getAdapterMapBinder(binder(), FXGeometricShapePart.class));
    bindFXGeometricCurvePartAdapters(AdapterMaps
                                     .getAdapterMapBinder(binder(), FXGeometricCurvePart.class));

    // node selection handles and multi selection handles
    bindFXSquareSegmentHandlePartAdapters(AdapterMaps.getAdapterMapBinder(
                                                                          binder(), FXSquareSegmentHandlePart.class));

    // curve selection handles
    bindFXCircleSegmentHandlePartAdapters(AdapterMaps.getAdapterMapBinder(
                                                                          binder(), FXCircleSegmentHandlePart.class));
    bindFXRectangleSegmentHandlePartAdapters(
                                             AdapterMaps.getAdapterMapBinder(binder(),
                                                                             FXRectangleSegmentHandlePart.class));

    // hover handles
    bindFXDeleteHandlePartAdapters(AdapterMaps.getAdapterMapBinder(binder(),
                                                                   FXDeleteHoverHandlePart.class));
    bindFXCreateCurveHandlePartAdapters(AdapterMaps.getAdapterMapBinder(
                                                                        binder(), FXCreateCurveHoverHandlePart.class));
  }

}